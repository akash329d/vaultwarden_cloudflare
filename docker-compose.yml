services:
  vaultwarden:
    image: vaultwarden/server:alpine
    restart: always
    volumes:
      - ${PWD}/vaultwarden/:/data/
    environment:
      WEBSOCKET_ENABLED: true
      LOG_FILE: /data/vaultwarden.log
      DOMAIN: https://${DOMAIN}
      SMTP_FROM_NAME: Vaultwarden (${DOMAIN})
      IP_HEADER: CF-Connecting-IP

  cloudflared:
    image: cloudflare/cloudflared
    restart: always
    command: tunnel --no-autoupdate run --token ${CF_TOKEN}
    depends_on:
      - vaultwarden

  watchtower:
    image: containrrr/watchtower
    restart: always
    depends_on:
      - vaultwarden
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      WATCHTOWER_CLEAUP: true

  rclone:
    image: rclone/rclone
    restart: always
    depends_on:
      - vaultwarden
    volumes:
      - ${PWD}/vaultwarden/:/data/
      - ${PWD}/backup/:/backup/
      - ${PWD}/backup_script:/etc/periodic/15min/:ro
      - ${PWD}/rclone:/config/
    entrypoint: /bin/sh
    command: /sbin/apk --update --no-cache add sqlite zip && crond -fS